---
name: api-plan-workflow
description: API 계획서 작성부터 전문가 리뷰까지 한번에 진행하는 통합 워크플로우입니다. 새로운 API 개발, 도메인 구현 요청 시 계획 수립과 리뷰를 자동으로 연결합니다.
---

# API Plan Workflow

신규 API 구현을 위한 **계획서 작성 → 전문가 리뷰**를 한번에 진행합니다.

---

## 워크플로우 개요

```
┌─────────────────────────────────────────────────────────────┐
│                    API Plan Workflow                        │
├─────────────────────────────────────────────────────────────┤
│  Phase 1: Planning (Plan Mode)                              │
│  ├── 도메인 분석                                              │
│  ├── API 명세 분석                                            │
│  └── 계획서 작성                                              │
├─────────────────────────────────────────────────────────────┤
│  Phase 2: Review (자동 전환)                                  │
│  ├── 6인 전문가 리뷰                                          │
│  ├── 리뷰 리포트 생성                                          │
│  └── 수정 사항 도출                                            │
├─────────────────────────────────────────────────────────────┤
│  Phase 3: Finalize                                          │
│  ├── 수정 필요시 → 계획서 수정 후 재리뷰                         │
│  └── 승인시 → 다음 단계 안내                                    │
└─────────────────────────────────────────────────────────────┘
```

---

## Phase 1: 계획서 작성

### Step 1.1: Plan Mode 진입

**이 스킬은 반드시 Plan Mode에서 시작합니다.**

`EnterPlanMode` 도구를 호출하여 계획 모드로 진입하세요.

---

### Step 1.2: 도메인 분석

현재 프로젝트 상태를 분석합니다:

1. **API 명세 확인**: `docs/05_api/api_*.md` 파일 목록
2. **구현 현황 확인**: `backend/app/api/v1/routes/*.py` 파일 목록
3. **미구현 도메인 식별**: 명세는 있으나 코드가 없는 도메인

사용자에게 질문 (AskUserQuestion):
> 어떤 도메인의 API를 계획할까요?
> - 미구현 도메인 목록 표시
> - 특정 엔드포인트만 선택 가능

---

### Step 1.3: API 명세 분석

선택된 도메인의 명세 파일 읽기:
- `docs/05_api/api_{domain}.md`

추출할 정보:
- 엔드포인트 목록 (method, path, summary)
- Request/Response 스키마
- 에러 응답 코드
- 의사코드 로직
- 구현 힌트

---

### Step 1.4: 계획서 작성

계획서 파일에 아래 템플릿으로 작성:

```markdown
# {Domain} API 구현 계획

## 1. 개요

| 항목 | 내용 |
|------|------|
| 도메인 | {domain} |
| API 명세 | docs/05_api/api_{domain}.md |
| 엔드포인트 수 | N개 |
| 예상 복잡도 | 낮음/중간/높음 |
| 외부 의존성 | (있다면) |

## 2. 엔드포인트 상세

### 2.1 {엔드포인트 1}
- **Method**: POST/GET/...
- **Path**: /api/v1/{domain}/...
- **Summary**: ...
- **인증**: 필요/불필요
- **Rate Limit**: 필요시 명시

**Request:**
```json
{
  "field": "type"
}
```

**Response:**
```json
{
  "field": "type"
}
```

**비즈니스 로직:**
1. 입력 검증
2. ...
3. 결과 반환

**에러 케이스:**
- 400: 잘못된 요청
- 401: 인증 필요
- 403: 권한 없음
- 404: 리소스 없음

### 2.2 {엔드포인트 2}
(반복)

## 3. 인가(Authorization) 매트릭스

| 엔드포인트 | 인증 | 권한 | 본인확인 | 비고 |
|-----------|------|------|---------|------|
| GET /api/v1/{domain} | ✅ | - | - | 목록 조회 |
| POST /api/v1/{domain} | ✅ | - | - | 생성 |
| GET /api/v1/{domain}/{id} | ✅ | - | owner | 본인 것만 |
| PATCH /api/v1/{domain}/{id} | ✅ | - | owner | 본인 것만 |
| DELETE /api/v1/{domain}/{id} | ✅ | admin | - | 관리자만 |

**권한 설명:**
- `owner`: 리소스 소유자만 접근 가능
- `admin`: 관리자 권한 필요
- `-`: 인증만 되면 접근 가능

## 4. 데이터 모델

### 4.1 DB 테이블
- 사용할 테이블: `docs/04_database/database_mysql.md` 참조
- 신규 테이블 필요 여부

### 4.2 Pydantic 스키마
| 스키마명 | 용도 | 필드 |
|----------|------|------|
| {Domain}CreateRequest | 생성 요청 | ... |
| {Domain}UpdateRequest | 수정 요청 | ... |
| {Domain}Response | 응답 | ... |
| {Domain}ListResponse | 목록 응답 | items, total, page |

## 5. 생성할 파일

### 5.1 프로덕션 코드
- [ ] `backend/app/api/v1/routes/{domain}.py` - 라우터
- [ ] `backend/app/domains/{domain}/schemas.py` - 스키마
- [ ] `backend/app/domains/{domain}/service.py` - 서비스
- [ ] `backend/app/domains/{domain}/repository.py` - 리포지토리
- [ ] `backend/app/domains/{domain}/models.py` - ORM 모델 (필요시)

### 5.2 테스트 코드
- [ ] `backend/tests/unit/{domain}/test_service.py`
- [ ] `backend/tests/unit/{domain}/test_repository.py`
- [ ] `backend/tests/integration/{domain}/test_{endpoint}.py`

## 6. 구현 순서 (TDD)

### Phase 1: 테스트 작성 (RED)
1. 단위 테스트 스켈레톤 작성
2. 통합 테스트 스켈레톤 작성
3. `pytest` 실행하여 실패 확인

### Phase 2: 구현 (GREEN)
1. 스키마 정의
2. 리포지토리 구현
3. 서비스 구현
4. 라우터 구현
5. 테스트 통과 확인 (커버리지 80% 이상)

### Phase 3: 정리 (REFACTOR)
1. 코드 정리
2. 라우터 등록
3. 문서 업데이트

## 7. DB 마이그레이션

### 7.1 변경 사항
- [ ] 신규 테이블: (있다면)
- [ ] 컬럼 추가: (있다면)
- [ ] 인덱스 추가: (있다면)

### 7.2 마이그레이션 계획
```bash
# 1. 마이그레이션 생성
alembic revision --autogenerate -m "{domain}: description"

# 2. 마이그레이션 검토 (자동 생성 결과 확인)
cat alembic/versions/{revision}_*.py

# 3. 마이그레이션 적용
alembic upgrade head

# 4. 롤백 계획 (문제 발생 시)
alembic downgrade -1
```

### 7.3 롤백 전략
- 롤백 스크립트 검증 필수
- 데이터 손실 가능성 확인
- 프로덕션 적용 전 스테이징 테스트

## 8. 로깅 계획

### 8.1 로깅 포인트
| 레벨 | 위치 | 내용 | 예시 |
|------|------|------|------|
| INFO | Service 시작 | 요청 정보 | `{domain}.create started: user_id={user_id}` |
| INFO | Service 완료 | 결과 요약 | `{domain}.create completed: id={id}` |
| WARNING | 비즈니스 예외 | 예외 상황 | `{domain} not found: id={id}` |
| ERROR | 시스템 예외 | 스택 트레이스 | `{domain}.create failed: {error}` |

### 8.2 로깅 금지 항목
- 비밀번호, 토큰
- 개인정보 (이메일 전체, 전화번호)
- 카드 정보
- API 키

## 9. 의존성 & 연동

### 9.1 내부 의존성
- 참조할 기존 모듈: auth, users
- 공용 유틸리티: core/security.py, utils/...

### 9.2 외부 의존성
- 외부 API: (있다면)
- 환경 변수: (필요시)

## 10. 주의사항 & 리스크

### 10.1 기술적 주의사항
- (명세에서 발견한 특이사항)
- (구현 힌트에서 추출한 내용)

### 10.2 비즈니스 주의사항
- (도메인 특수 규칙)

### 10.3 보안 고려사항
- 인증/인가 요구사항 (위 매트릭스 참조)
- 입력 검증 포인트
- 민감 데이터 처리
- CSRF 보호 필요 여부
- CORS 설정 확인

### 10.4 성능 고려사항
- N+1 쿼리 방지
- 페이지네이션 필수 여부
- 캐싱 필요 여부

## 11. 체크리스트

구현 완료 시 확인:
- [ ] 모든 테스트 통과
- [ ] 커버리지 80% 이상
- [ ] 코딩 표준 준수 (docs/06_code/code_backend.md)
- [ ] API 문서 자동 생성 확인 (/docs)
- [ ] 에러 처리 완료
- [ ] 로깅 추가
- [ ] 인가 검증 완료
- [ ] 마이그레이션 적용 (필요시)
```

---

### Step 1.5: Plan Mode 종료

계획서 작성 완료 후 `ExitPlanMode`를 호출합니다.

**중요**: Plan Mode 종료 후 자동으로 Phase 2 리뷰로 전환됩니다.

---

## Phase 2: 전문가 리뷰 (자동 실행)

**Phase 1 완료 즉시 아래 리뷰를 자동 수행합니다.**

### Step 2.1: 계획서 읽기

방금 작성한 계획서 파일을 읽습니다.

---

### Step 2.2: 6인 전문가 관점 리뷰

**6명의 가상 전문가**가 각자의 관점에서 계획서를 검토합니다:

---

#### 👨‍💻 Backend Architect (백엔드 아키텍트)

**검토 항목:**
- 레이어 분리가 적절한가? (Router → Service → Repository)
- 의존성 방향이 올바른가?
- 확장성을 고려했는가?
- 기존 패턴과 일관성이 있는가?

**체크리스트:**
- [ ] Service/Repository 패턴 준수
- [ ] 순환 의존성 없음
- [ ] 단일 책임 원칙(SRP) 준수
- [ ] 적절한 추상화 수준

---

#### 🔒 Security Engineer (보안 엔지니어)

**검토 항목:**
- 인증/인가가 적절히 설계되었는가?
- 입력 검증이 충분한가?
- 민감 데이터 처리가 안전한가?
- OWASP Top 10 취약점 고려했는가?

**체크리스트:**
- [ ] 인가 매트릭스 정의됨
- [ ] 모든 엔드포인트에 인증 요구사항 명시
- [ ] 입력 검증 포인트 정의
- [ ] SQL Injection 방지 (ORM 사용)
- [ ] XSS 방지 (출력 이스케이프)
- [ ] 민감 정보 로깅 금지
- [ ] Rate Limiting 적용
- [ ] CSRF/CORS 고려

---

#### 🧪 QA Engineer (품질 엔지니어)

**검토 항목:**
- 테스트 전략이 충분한가?
- 엣지 케이스를 고려했는가?
- 에러 케이스가 정의되었는가?
- TDD 원칙을 따르는가?

**체크리스트:**
- [ ] 단위 테스트 계획 있음
- [ ] 통합 테스트 계획 있음
- [ ] 에러 케이스 정의됨
- [ ] 경계값 테스트 고려
- [ ] 테스트 우선 구현 순서
- [ ] 커버리지 목표 80% 명시

---

#### 📊 DBA (데이터베이스 관리자)

**검토 항목:**
- 데이터 모델이 적절한가?
- 쿼리 성능을 고려했는가?
- 인덱스 전략이 있는가?
- 트랜잭션 범위가 적절한가?
- 마이그레이션 계획이 있는가?

**체크리스트:**
- [ ] 기존 테이블 스키마와 일치
- [ ] 필요한 인덱스 정의
- [ ] N+1 쿼리 문제 고려
- [ ] 트랜잭션 경계 명확
- [ ] 데이터 정합성 보장
- [ ] 마이그레이션 계획 있음
- [ ] 롤백 전략 정의

---

#### 🚀 DevOps Engineer (데브옵스 엔지니어)

**검토 항목:**
- 배포 시 고려사항이 있는가?
- 모니터링/로깅이 충분한가?
- 환경 변수 관리가 적절한가?
- 성능 병목이 예상되는가?

**체크리스트:**
- [ ] 환경 변수 목록 정의
- [ ] 로깅 포인트 정의
- [ ] 로깅 금지 항목 명시
- [ ] 헬스체크 엔드포인트 고려
- [ ] 에러 알림 기준 정의
- [ ] 롤백 전략 고려

---

#### 📝 Technical Writer (기술 문서 작성자)

**검토 항목:**
- 계획서 구조가 명확한가?
- 누락된 섹션이 있는가?
- 모호한 표현이 있는가?

**체크리스트:**
- [ ] 개요 섹션 완비
- [ ] 엔드포인트 상세 명시
- [ ] 에러 케이스 정의
- [ ] 구현 순서 명확
- [ ] 체크리스트 포함

---

### Step 2.3: 리뷰 리포트 출력

```markdown
# Plan Review Report

## 📋 계획서 요약
- 파일: {plan_file_path}
- 도메인: {domain}
- 엔드포인트: N개

---

## 👨‍💻 Backend Architect Review

### 평가: ⭐⭐⭐⭐☆ (4/5)

**잘된 점:**
- ...

**개선 필요:**
- ...

**권장 사항:**
1. ...

---

## 🔒 Security Engineer Review

### 평가: ⭐⭐⭐☆☆ (3/5)

**잘된 점:**
- ...

**보안 취약점:**
- [CRITICAL] ...
- [HIGH] ...
- [MEDIUM] ...
- [LOW] ...

**필수 수정:**
1. ...

---

## 🧪 QA Engineer Review

### 평가: ⭐⭐⭐⭐⭐ (5/5)

**잘된 점:**
- ...

**추가 테스트 케이스:**
- ...

---

## 📊 DBA Review

### 평가: ⭐⭐⭐⭐☆ (4/5)

**잘된 점:**
- ...

**성능 우려:**
- ...

**인덱스 제안:**
- ...

**마이그레이션 검토:**
- ...

---

## 🚀 DevOps Engineer Review

### 평가: ⭐⭐⭐⭐☆ (4/5)

**잘된 점:**
- ...

**운영 고려사항:**
- ...

---

## 📝 Technical Writer Review

### 평가: ⭐⭐⭐⭐☆ (4/5)

**잘된 점:**
- ...

**문서 개선:**
- ...

---

## 📊 종합 평가

| 전문가 | 평가 | 주요 이슈 |
|--------|------|-----------|
| Backend Architect | ⭐⭐⭐⭐☆ | ... |
| Security Engineer | ⭐⭐⭐☆☆ | ... |
| QA Engineer | ⭐⭐⭐⭐⭐ | ... |
| DBA | ⭐⭐⭐⭐☆ | ... |
| DevOps Engineer | ⭐⭐⭐⭐☆ | ... |
| Technical Writer | ⭐⭐⭐⭐☆ | ... |

**종합 점수: X.X / 5.0**

---

## ✅ 필수 수정 사항 (Must Fix)

1. [CRITICAL] ...
2. [HIGH] ...

## ⚠️ 권장 수정 사항 (Should Fix)

1. [MEDIUM] ...
2. [LOW] ...

## 💡 개선 제안 (Nice to Have)

1. ...
2. ...
```

---

## Phase 3: 최종 확인

### Step 3.1: 사용자에게 선택지 제공

리뷰 완료 후 사용자에게 질문 (AskUserQuestion):

> 리뷰가 완료되었습니다. 다음 중 선택하세요:
> 1. **계획서 수정** - 리뷰 피드백 반영 후 재리뷰
> 2. **계획서 승인** - 현재 상태로 구현 진행
> 3. **리뷰 재요청** - 특정 관점만 다시 리뷰

---

### Step 3.2: 선택에 따른 처리

**계획서 수정 선택 시:**
1. 필수 수정 사항(Must Fix) 기반으로 계획서 수정
2. Phase 2 리뷰 자동 재실행

**계획서 승인 선택 시:**
1. 최종 계획서 저장 확인
2. 다음 단계 안내: `/api-scaffold` - 코드 생성

**리뷰 재요청 선택 시:**
1. 원하는 전문가 관점 선택
2. 해당 관점만 재리뷰

---

## 참조 문서

- API 명세: `docs/05_api/`
- DB 스키마: `docs/04_database/database_mysql.md`
- 코딩 표준: `docs/06_code/code_backend.md`
- TDD 가이드: `docs/06_code/code_tdd.md`
- 레이어 아키텍처: `docs/06_code/code_backend_layers.md`

---

## 트러블슈팅

### Plan Mode 진입 실패
1. `EnterPlanMode` 도구 직접 호출
2. 또는 대화로 "계획 모드로 진입해줘" 요청

### 명세 파일을 찾을 수 없음
1. `docs/05_api/` 디렉토리 확인
2. 파일명 패턴: `api_{domain}.md`
3. 없으면 명세 먼저 작성 필요

### 계획서 저장 위치
- 자동: `.claude/plans/{domain}-api-plan-{date}.md`
- 수동 지정 가능

### 리뷰가 너무 오래 걸림
1. 계획서 크기가 큰 경우 도메인별로 분리 고려
2. 특정 전문가 관점만 요청: "보안 관점에서만 리뷰해줘"

### 리뷰 결과가 너무 엄격함
1. 프로젝트 단계 고려 (MVP vs Production)
2. Must Fix만 우선 반영
3. Nice to Have는 백로그로 관리

---

## 다음 단계

워크플로우 완료 후:
1. `/api-scaffold` - 코드 생성
2. 구현 진행 (TDD 방식)
