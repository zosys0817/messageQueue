# RabbitMQ Configuration for Production Cluster
# File: /etc/rabbitmq/rabbitmq.conf
# 용도: 온프레미스 3대 서버 클러스터 설정

## ============================================
## Cluster Configuration
## ============================================

# 클러스터 이름
cluster_name = production-cluster

# 네트워크 파티션 처리 전략
# - ignore: 아무 조치 안 함 (기본값)
# - autoheal: 자동으로 복구 시도 (권장)
# - pause_minority: 소수 노드 일시정지
cluster_partition_handling = autoheal

## ============================================
## Logging
## ============================================

# 콘솔 로그 레벨 (debug | info | warning | error)
log.console.level = info

# 파일 로그 레벨
log.file.level = info

# 로그 파일 경로
# log.file = /var/log/rabbitmq/rabbit.log

## ============================================
## Memory Management
## ============================================

# 메모리 사용 임계치 (전체 메모리의 40%)
# 이 값을 초과하면 Producer 차단 및 디스크로 메시지 이동
vm_memory_high_watermark.relative = 0.4

# 또는 절대값 지정 (예: 4GB)
# vm_memory_high_watermark.absolute = 4GB

# 페이징 시작 비율 (메모리 임계치의 75%)
vm_memory_high_watermark_paging_ratio = 0.75

## ============================================
## Disk Space Management
## ============================================

# 디스크 여유 공간 최소값 (5GB 미만 시 경고 및 Producer 차단)
disk_free_limit.absolute = 5GB

# 또는 상대값 지정 (전체 디스크의 10%)
# disk_free_limit.relative = 1.0

## ============================================
## Network Configuration
## ============================================

# AMQP 클라이언트 리스너
listeners.tcp.default = 5672

# AMQPS (TLS) 리스너 (TLS 설정 시 활성화)
# listeners.ssl.default = 5671

# Management UI 포트
management.tcp.port = 15672
management.tcp.ip = 0.0.0.0

# Prometheus 메트릭 포트
prometheus.tcp.port = 15692

## ============================================
## TLS/SSL Configuration (선택)
## ============================================

# TLS 활성화 시 주석 해제
# ssl_options.cacertfile = /etc/rabbitmq/certs/ca_certificate.pem
# ssl_options.certfile   = /etc/rabbitmq/certs/server_certificate.pem
# ssl_options.keyfile    = /etc/rabbitmq/certs/server_key.pem
# ssl_options.verify     = verify_peer
# ssl_options.fail_if_no_peer_cert = false

# TLS 버전 (1.2 이상)
# ssl_options.versions.1 = tlsv1.2
# ssl_options.versions.2 = tlsv1.3

## ============================================
## Heartbeat & Timeouts
## ============================================

# Heartbeat 간격 (초) - 클라이언트 연결 유지 확인
heartbeat = 60

# Handshake 타임아웃 (밀리초)
handshake_timeout = 10000

## ============================================
## TCP Options
## ============================================

# TCP 백로그 큐 크기
tcp_listen_options.backlog = 128

# TCP_NODELAY (Nagle 알고리즘 비활성화 - 지연 감소)
tcp_listen_options.nodelay = true

# 송신 버퍼 크기
tcp_listen_options.sndbuf = 196608

# 수신 버퍼 크기
tcp_listen_options.recbuf = 196608

## ============================================
## Queue Configuration (기본값)
## ============================================

# 기본 큐 타입 (classic | quorum | stream)
# default_queue_type = classic

# Quorum Queue 최소 복제본 수 (기본: 과반수)
# quorum_queue_min_replicas = 2

## ============================================
## Message TTL & Limits
## ============================================

# 기본 메시지 TTL (밀리초) - 설정 안 함 (큐별로 설정 권장)
# default_message_ttl = 3600000

# 최대 메시지 크기 (바이트) - 128MB
max_message_size = 134217728

## ============================================
## Plugins
## ============================================

# 활성화된 플러그인 목록은 다음 명령으로 확인:
# rabbitmq-plugins list

# 필수 플러그인:
# - rabbitmq_management (Management UI)
# - rabbitmq_prometheus (Prometheus 메트릭)

## ============================================
## Cluster Performance Tuning
## ============================================

# 채널 최대 개수 (연결당)
channel_max = 2047

# 최대 프레임 크기 (바이트)
frame_max = 131072

# 클러스터 노드 간 통신 포트
# (자동 설정: EPMD 4369, Inter-node 25672)

## ============================================
## Management UI Configuration
## ============================================

# HTTP API 요청 타임아웃 (밀리초)
management.http_log_dir = /var/log/rabbitmq

# CORS 활성화 (외부에서 API 호출 시)
# management.cors.allow_origins.1 = *
# management.cors.allow_origins.2 = https://monitoring.example.com

## ============================================
## Consumer Timeout (메시지 처리 타임아웃)
## ============================================

# Consumer가 메시지를 Ack하지 않고 보유할 수 있는 최대 시간 (밀리초)
# 기본값: 30분 (1800000)
consumer_timeout = 1800000

## ============================================
## Mirroring (Classic Queue HA)
## ============================================

# Classic Queue 미러링은 deprecated됨
# 대신 Quorum Queue 사용 권장

## ============================================
## Resource Limits
## ============================================

# 최대 연결 수
# num_acceptors.tcp = 10

# 연결당 최대 큐 수
# max_queues = 1000
