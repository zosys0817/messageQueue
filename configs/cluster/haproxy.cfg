# HAProxy Configuration for RabbitMQ Cluster
# File: /etc/haproxy/haproxy.cfg
# 용도: RabbitMQ 3대 클러스터 로드밸런싱

## ============================================
## Global Settings
## ============================================

global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

    # TLS 설정 (사용 시)
    # ssl-default-bind-ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384
    # ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11

    # 성능 튜닝
    maxconn 40000
    tune.ssl.default-dh-param 2048

## ============================================
## Defaults
## ============================================

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    retries 3
    option  redispatch

## ============================================
## Statistics Page
## ============================================

listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
    stats auth admin:haproxy-stats-password  # 변경 필수!

## ============================================
## RabbitMQ AMQP (Port 5672)
## ============================================

frontend rabbitmq_amqp_front
    bind *:5672
    mode tcp
    default_backend rabbitmq_amqp_back

backend rabbitmq_amqp_back
    mode tcp
    balance roundrobin
    option tcplog

    # Health Check (AMQP 포트 체크)
    option tcp-check
    tcp-check connect port 5672

    # 서버 목록
    server rabbit-node1 192.168.1.11:5672 check inter 5000 rise 2 fall 3
    server rabbit-node2 192.168.1.12:5672 check inter 5000 rise 2 fall 3
    server rabbit-node3 192.168.1.13:5672 check inter 5000 rise 2 fall 3

## ============================================
## RabbitMQ AMQPS (Port 5671) - TLS
## ============================================

frontend rabbitmq_amqps_front
    bind *:5671
    mode tcp
    default_backend rabbitmq_amqps_back

backend rabbitmq_amqps_back
    mode tcp
    balance roundrobin
    option tcplog

    # Health Check
    option tcp-check
    tcp-check connect port 5671

    # 서버 목록
    server rabbit-node1 192.168.1.11:5671 check inter 5000 rise 2 fall 3
    server rabbit-node2 192.168.1.12:5671 check inter 5000 rise 2 fall 3
    server rabbit-node3 192.168.1.13:5671 check inter 5000 rise 2 fall 3

## ============================================
## RabbitMQ Management UI (Port 15672)
## ============================================

frontend rabbitmq_management_front
    bind *:15672
    mode http
    default_backend rabbitmq_management_back

backend rabbitmq_management_back
    mode http
    balance roundrobin
    option httpchk GET /api/health/checks/alarms
    http-check expect status 200

    # Cookie 기반 세션 유지 (Management UI 로그인 유지)
    cookie SERVERID insert indirect nocache

    # 서버 목록
    server rabbit-node1 192.168.1.11:15672 check cookie node1
    server rabbit-node2 192.168.1.12:15672 check cookie node2
    server rabbit-node3 192.168.1.13:15672 check cookie node3

## ============================================
## RabbitMQ Prometheus Metrics (Port 15692)
## ============================================

frontend rabbitmq_prometheus_front
    bind *:15692
    mode http
    default_backend rabbitmq_prometheus_back

backend rabbitmq_prometheus_back
    mode http
    balance roundrobin

    # 서버 목록
    server rabbit-node1 192.168.1.11:15692 check
    server rabbit-node2 192.168.1.12:15692 check
    server rabbit-node3 192.168.1.13:15692 check

## ============================================
## 설명
## ============================================

# 1. AMQP Frontend/Backend (5672)
#    - 클라이언트는 HAProxy IP:5672로 연결
#    - Round-robin으로 3대 노드에 부하 분산
#    - Health Check: 5초마다 확인, 2회 성공 시 UP, 3회 실패 시 DOWN
#
# 2. Management UI (15672)
#    - Cookie 기반 세션 유지 (로그인 상태 유지)
#    - Health Check: /api/health/checks/alarms 엔드포인트
#
# 3. Statistics Page (8404)
#    - http://[haproxy-ip]:8404/stats
#    - 실시간 노드 상태 확인 가능
#
# 4. 설치 및 실행:
#    sudo yum install -y haproxy
#    sudo cp haproxy.cfg /etc/haproxy/haproxy.cfg
#    sudo systemctl enable haproxy
#    sudo systemctl start haproxy
#
# 5. 방화벽 설정:
#    sudo firewall-cmd --permanent --add-port=5672/tcp
#    sudo firewall-cmd --permanent --add-port=5671/tcp
#    sudo firewall-cmd --permanent --add-port=15672/tcp
#    sudo firewall-cmd --permanent --add-port=8404/tcp
#    sudo firewall-cmd --reload
